<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRYO-CHAMBER V31 [FINAL]</title>
    <style>
        /* --- UNIVERSAL RESET --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #050505;
            color: #e0f7fa;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            width: 100%; min-height: 100vh;
            overflow-x: hidden; display: flex; flex-direction: column;
            padding-bottom: 80px;
        }

        /* --- SCROLLBARS --- */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* --- PRE-SESSION MODAL --- */
        #pre-session-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        .modal-card {
            background: #001f3f; padding: 30px; border-radius: 10px; max-width: 90%;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            animation: zoomIn 0.3s;
        }
        @keyframes zoomIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }
        .modal-title { color: #00e5ff; font-size: 24px; margin-bottom: 10px; border-bottom: 1px solid #00e5ff; padding-bottom: 5px; }
        .modal-warn { color: #ff5252; font-size: 14px; margin: 15px 0; }
        .modal-instruct { text-align: left; margin: 20px 0; font-size: 14px; }
        .volume-visual { border: 1px solid #00e5ff; padding: 10px; margin-top: 15px; background: #000a12; }

        /* --- NAV BAR --- */
        .nav-bar {
            display: flex; width: 100%; background: #0a0a0a;
            border-bottom: 2px solid #00e5ff;
            position: sticky; top: 0; z-index: 1000;
            overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .nav-btn {
            flex: 1; min-width: 80px; padding: 15px 5px; background: #0a0a0a; color: #666;
            border: none; border-right: 1px solid #222; font-weight: bold; font-size: 12px; cursor: pointer; white-space: nowrap;
            font-family: monospace;
        }
        .nav-btn.active { background: #00e5ff; color: #000; }

        /* --- CONTENT --- */
        .content-wrapper {
            padding: 20px; flex: 1; max-width: 800px; margin: 0 auto;
            width: 100%; display: flex; flex-direction: column;
        }
        .tab-panel { display: none; width: 100%; flex: 1; }
        .tab-panel.visible { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* --- DR. ARCH (AI INTERFACE) --- */
        .doctor-header {
            display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px;
            border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .doctor-avatar {
            width: 50px; height: 50px; background: #00e5ff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; font-size: 24px;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5); cursor: pointer;
        }
        .doctor-info { font-size: 12px; color: #aaa; } .doctor-name { font-size: 18px; color: #fff; font-weight: bold; }

        .chat-window {
            flex: 1; min-height: 350px; max-height: 500px;
            background: #080808; border: 1px solid #333; border-radius: 8px;
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }
        .msg-row { display: flex; gap: 10px; }
        .msg-ai-bubble {
            background: #1a1a1a; color: #e0f7fa; padding: 15px; border-radius: 0 15px 15px 15px;
            max-width: 85%; font-size: 14px; line-height: 1.5; border-left: 3px solid #00e5ff;
        }
        .msg-user-bubble {
            background: #004d40; color: #fff; padding: 10px 15px; border-radius: 15px 15px 0 15px;
            max-width: 80%; font-size: 13px; margin-left: auto; text-align: right;
        }
        
        .choice-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; width: 100%; }
        .choice-btn {
            background: transparent; border: 1px solid #444; color: #aaa;
            padding: 12px; text-align: left; cursor: pointer; font-size: 13px; border-radius: 4px;
            transition: all 0.2s; display: flex; justify-content: space-between;
        }
        .choice-btn:hover { border-color: #00e5ff; color: #00e5ff; background: rgba(0, 229, 255, 0.05); }

        .prescription-card {
            background: #002220; border: 1px solid #00e5ff; padding: 20px; margin-top: 10px; border-radius: 8px; text-align: center;
            animation: slideUp 0.5s;
        }
        @keyframes slideUp { from{transform:translateY(20px); opacity:0;} to{transform:translateY(0); opacity:1;} }
        .rx-header { color: #00e5ff; font-size: 12px; letter-spacing: 2px; margin-bottom: 5px; }
        .rx-title { color: #fff; font-size: 22px; font-weight: bold; margin-bottom: 10px; }
        .rx-time { font-family: monospace; color: #ffd700; font-size: 14px; border: 1px solid #ffd700; display: inline-block; padding: 5px 10px; border-radius: 4px; margin-bottom: 15px; }

        /* --- ARCHITECT CONSOLE --- */
        #architect-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 30, 0.95); z-index: 9000;
            display: none; flex-direction: column; align-items: center; padding: 20px;
            font-family: monospace;
        }
        .architect-header { color: #ffd700; font-size: 20px; border-bottom: 2px solid #ffd700; padding-bottom: 10px; margin-bottom: 20px; }
        .architect-btn {
            width: 100%; max-width: 400px; padding: 15px; margin-bottom: 10px;
            background: #333; color: #fff; border: 1px solid #ffd700; cursor: pointer;
            font-size: 16px; transition: background 0.2s;
        }
        .architect-close { color: #888; font-size: 12px; margin-top: 20px; cursor: pointer; }


        /* --- CONTROL PANEL --- */
        .system-group { margin-bottom: 20px; }
        .system-label { font-size: 10px; color: #888; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .med-btn {
            width: 100%; background: #111; border: 1px solid #333; border-left-width: 4px;
            color: #ccc; padding: 15px; margin-bottom: 8px; text-align: left; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s; border-radius: 0 4px 4px 0;
        }
        .med-btn:hover { background: #1a1a1a; color: #fff; }
        .med-btn.active-protocol { background: #1a1a1a; color: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.5); border-color: #fff; }
        
        .border-fire { border-left-color: #ff5252; } .border-earth { border-left-color: #69f0ae; }
        .border-water { border-left-color: #40c4ff; } .border-air { border-left-color: #e040fb; }
        .border-aether { border-left-color: #ffd740; } .border-void { border-left-color: #fff; }
        .btn-icon { font-size: 18px; margin-right: 10px; width: 20px; text-align: center; }
        .btn-main { font-weight: bold; font-size: 14px; } .btn-desc { font-size: 11px; color: #666; } 
        .btn-meta { text-align: right; }
        .btn-freq { font-family: monospace; font-size: 10px; color: #00e5ff; }
        .btn-time { font-family: monospace; font-size: 10px; color: #ffd700; }

        /* --- BIO & STATUS --- */
        .bio-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: #0a0a0a; border: 1px solid #333; padding: 10px; margin-bottom: 15px;
            border-left: 4px solid #333; transition: border-color 0.5s; border-radius: 4px;
        }
        .bio-val { font-size: 20px; font-weight: bold; color: #fff; } .bio-label { font-size: 10px; color: #888; text-transform: uppercase; }
        .bio-btn { background: #222; border: 1px solid #555; color: #fff; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 4px; }
        .status-box { border: 1px solid #333; background: #0a0a0a; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #222; padding-bottom: 4px; color: #aaa; }
        .value-text { color: #fff; font-family: monospace; }

        /* --- DATA ARCHIVE --- */
        .terminal-window { 
            width: 100%; height: 350px; background: #e0e0e0; color: #111;
            border: 1px solid #fff; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; white-space: pre; user-select: text; -webkit-user-select: text;
        }
        .data-controls { display: flex; gap: 5px; margin-top: 10px; }
        .data-btn { flex: 1; padding: 10px; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; }
        .instruct-text { font-size: 11px; color: #888; margin-bottom: 5px; text-align: center; }

        /* --- BREATH --- */
        .breath-box { height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .circle { width: 100px; height: 100px; border: 4px solid #00e5ff; border-radius: 50%; opacity: 0.3; transform: scale(0.8); transition: all 5.5s ease-in-out; }
        .circle.inhale { transform: scale(2.0); opacity: 1; } .circle.exhale { transform: scale(0.8); opacity: 0.3; }
        
        /* --- GLOBAL FOOTER --- */
        .global-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 70px; background: #080808; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            z-index: 5000; padding: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .global-btn {
            width: 100%; height: 100%; max-width: 600px;
            font-size: 16px; font-weight: bold; letter-spacing: 1px;
            border: none; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s; border-radius: 4px;
        }
        .btn-idle { background: #222; color: #666; border: 1px solid #333; }
        .btn-active { background: #b71c1c; color: #fff; border: 1px solid #ff5252; animation: pulse-red 2s infinite; }
        .btn-resume { background: #004d40; color: #00e5ff; border: 1px solid #00bfa5; }
        @keyframes pulse-red { 0% {box-shadow: 0 0 5px #b71c1c;} 50% {box-shadow: 0 0 15px #ff5252;} 100% {box-shadow: 0 0 5px #b71c1c;} }

        .mode-banner { display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; border: 1px solid #333; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .current-mode-text { font-size: 12px; color: #888; } .mode-name { font-size: 14px; font-weight: bold; color: #00e5ff; }
        .change-mode-btn { background: #222; color: #fff; border: 1px solid #555; padding: 6px 12px; font-size: 10px; cursor: pointer; border-radius: 3px; }
        .apply-btn { background: #00e5ff; color: #000; font-weight: bold; padding: 15px; width: 100%; cursor: pointer; border: none; margin-top: 15px; text-transform: uppercase; border-radius: 4px; }

    </style>
</head>
<body onload="selectLaunchMode('vehicle')">

    <div id="pre-session-modal">
        <div class="modal-card">
            <div class="modal-title" id="modal-title">PROTOCOL: TETRAHEDRON</div>
            <div class="modal-warn">CRITICAL: Review Volume Setting Before Continuing.</div>
            <div class="modal-instruct" id="modal-instruct-text"></div>
            
            <div class="volume-visual">
                
            </div>

            <button class="apply-btn" onclick="startTreatmentNow()">START TREATMENT NOW</button>
        </div>
    </div>
    
    <div id="architect-console">
        <div class="architect-header">ARCHITECT CONSOLE: ADVANCED SYNTHESIS</div>
        <button class="architect-btn" onclick="toggleArchitectMode(); showPreSessionModal('DISCHARGE_33')">
            GAMMA DISCHARGE (33Hz) âš¡
        </button>
        <button class="architect-btn" onclick="toggleArchitectMode(); showPreSessionModal('Icosahedron_Intent')">
            ACAUSAL CLARITY (Flow State)
        </button>
        <div class="architect-close" onclick="toggleArchitectMode()">[ CLOSE CONSOLE ]</div>
    </div>


    <div class="nav-bar">
        <button id="nav-diag" class="nav-btn active" onclick="showTab('diagnostic', this)">DIAGNOSE</button>
        <button id="nav-ctrl" class="nav-btn" onclick="showTab('controls', this)">CONTROLS</button>
        <button id="nav-breath" class="nav-btn" onclick="showTab('breath', this)">PACER</button>
        <button id="nav-data" class="nav-btn" onclick="showTab('data', this)">ARCHIVE</button>
        <button id="nav-guide" class="nav-btn" onclick="showTab('guide', this)">MANUAL</button>
    </div>

    <div class="content-wrapper">
        
        <div id="diagnostic" class="tab-panel visible">
            <div class="doctor-header">
                <div class="doctor-avatar" onclick="handleDoctorTap()">âœš</div>
                <div class="doctor-info">
                    <div class="doctor-name">Dr. Arch</div>
                    <div>Cryo-Acoustic Specialist</div>
                </div>
                <button class="reset-btn" onclick="initChat()">RESTART CONSULTATION</button>
            </div>
            <div id="chat-window" class="chat-window"></div>
        </div>

        <div id="controls" class="tab-panel">
            <div class="mode-banner">
                <div>
                    <div class="current-mode-text">ENVIRONMENT</div>
                    <div class="mode-name" id="active-mode-name">--</div>
                </div>
                <button class="change-mode-btn" onclick="toggleMode()">SWITCH</button>
            </div>

            <div class="bio-bar" id="bio-panel">
                <div>
                    <div class="bio-label">HEART RATE</div>
                    <div class="bio-val"><span id="bpm-display">--</span> <span style="font-size:12px">BPM</span></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="bio-btn" onclick="connectBluetooth()">BLE LINK</button>
                    <button class="bio-btn" onclick="tapTempo()">TAP</button>
                </div>
            </div>

            <div class="status-box">
                <div class="status-row"><span>PROTOCOL:</span><span id="geo-text" class="value-text">--</span></div>
                <div class="status-row"><span>MIND (Hz):</span><span id="freq-text" class="value-text">0 Hz</span></div>
                <div class="status-row"><span>BODY (Hz):</span><span id="vib-text" class="value-text">0 Hz</span></div>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: ORTHOPEDIC (Structural Integrity)</div>
                <button id="btn-Tetrahedron" class="med-btn border-fire" onclick="showPreSessionModal('Tetrahedron')">
                    <span class="btn-icon">â–³</span>
                    <div>
                        <div class="btn-main">TETRAHEDRON</div>
                        <div class="btn-desc">Bone Density & Strength</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">720Hz</div><div class="btn-time">24 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: NEUROLOGY (Stability & Grounding)</div>
                <button id="btn-Cube" class="med-btn border-earth" onclick="showPreSessionModal('Cube')">
                    <span class="btn-icon">â–¡</span>
                    <div>
                        <div class="btn-main">CUBE</div>
                        <div class="btn-desc">Anxiety Relief & Grounding</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">2160Hz</div><div class="btn-time">20 MIN</div></div>
                </button>
                <button id="btn-Octahedron" class="med-btn border-air" onclick="showPreSessionModal('Octahedron')">
                    <span class="btn-icon">â—‡</span>
                    <div>
                        <div class="btn-main">OCTAHEDRON</div>
                        <div class="btn-desc">Mental Focus & Balance</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">1440Hz</div><div class="btn-time">15 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: VASCULAR (Flow & Fluids)</div>
                <button id="btn-Icosahedron" class="med-btn border-water" onclick="showPreSessionModal('Icosahedron')">
                    <span class="btn-icon">ðŸ’§</span>
                    <div><div class="btn-main">ICOSAHEDRON</div><div class="btn-desc">Inflammation & Flow</div></div>
                    <div class="btn-meta"><div class="btn-freq">360Hz</div><div class="btn-time">18 MIN</div></div>
                </button>
                <button id="btn-Torus" class="med-btn border-void" onclick="showPreSessionModal('Torus')">
                    <span class="btn-icon">â—Ž</span>
                    <div><div class="btn-main">TORUS</div><div class="btn-desc">Heart Coherence & Stagnation</div></div>
                    <div class="btn-meta"><div class="btn-freq">194Hz</div><div class="btn-time">22 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: CELLULAR & FIELD (Repair)</div>
                <button id="btn-Dodecahedron" class="med-btn border-aether" onclick="showPreSessionModal('Dodecahedron')">
                    <span class="btn-icon">â¬¡</span>
                    <div><div class="btn-main">DODECAHEDRON</div><div class="btn-desc">DNA Repair & Toxicity</div></div>
                    <div class="btn-meta"><div class="btn-freq">432Hz</div><div class="btn-time">33 MIN</div></div>
                </button>
                <button id="btn-Sphere" class="med-btn border-void" onclick="showPreSessionModal('Sphere')">
                    <span class="btn-icon">â—¯</span>
                    <div><div class="btn-main">SPHERE</div><div class="btn-desc">EMF Protection Shield</div></div>
                    <div class="btn-meta"><div class="btn-freq">7.83Hz</div><div class="btn-time">45 MIN</div></div>
                </button>
            </div>
        </div>

        <div id="breath" class="tab-panel">
            <div style="text-align: center; color: #00e5ff; margin-bottom: 20px;">COHERENCE PROTOCOL (0.1 Hz)</div>
            <div class="breath-box">
                <div id="breath-circle" class="circle"></div>
                <h2 id="breath-text" style="margin-top: 30px;">READY</h2>
            </div>
            <button class="apply-btn" style="margin-top:20px; background:transparent; border:1px solid #00e5ff; color:#00e5ff;" onclick="toggleBreath()">START PACER</button>
        </div>

        <div id="data" class="tab-panel">
            <h3 style="color: #00e5ff; border-bottom: 1px solid #333; padding-bottom: 10px;">PATIENT RECORDS</h3>
            <div class="instruct-text">LONG PRESS TO COPY LOGS</div>
            <textarea id="log-terminal" class="terminal-window" readonly>NO RECORDS FOUND.</textarea>
            <div class="data-controls">
                <button class="data-btn" onclick="selectAllData()">SELECT ALL</button>
                <button class="data-btn" style="color:#ff5252; border-color:#552222;" onclick="clearData()">CLEAR RECORDS</button>
            </div>
        </div>

        <div id="guide" class="tab-panel">
            <h3 style="color:#ffd700">CLINICAL GUIDE</h3>
            <p><strong>1. DIAGNOSTIC FIRST</strong><br>Dr. Arch will ask you to define your Intent (Repair vs. Optimize) before selecting a protocol.</p>
            <p><strong>2. AUTO-DOSING</strong><br>The system sets the exact duration needed for your specific tissue type (e.g. Bone requires 24min, Blood requires 18min).</p>
            <p><strong>3. MODALITIES</strong><br>[VEHICLE] = Chassis Resonance.<br>[HEADSET] = Binaural Entrainment.</p>
        </div>
    </div>

    <div class="global-footer">
        <button id="global-btn" class="global-btn btn-idle" onclick="handleGlobalClick()">SELECT PROTOCOL</button>
    </div>

    <script>
        // --- SYSTEM VARS ---
        let audioCtx = null; let masterGain; let systemMode = 'vehicle'; 
        let oscHigh, oscLow, oscBin;
        let currentBPM=0; let startBPM=0; let tapTimes=[];
        let sessionStart=0; let currentGeo=""; let currentHigh=0; currentLow=0;
        let breathTimer=null; let isBreathing=false;
        let lastGeo = null; let lastHigh = 0; let lastLow = 0; let isPlaying = false;
        let pendingDiagnosis = null;
        let doseTimer = null; let remainingSeconds = 0;
        let tapCounter = 0; 

        // --- AI LOGIC (OMNI-DIMENSIONAL) ---
        const diagnosticTree = {
            start: { q: "Welcome. Are we initiating a session for REPAIR (Healing) or OPTIMIZATION (Enhancement)?", options: [{text:"REPAIR / HEALING",next:"path_repair"},{text:"OPTIMIZATION / GOALS",next:"path_optimize"}] },
            path_repair: { q: "Please identify the primary system of distress.", options: [{text:"Somatic / Structural Pain",next:"physical"},{text:"Emotional / Mental Stress",next:"emo_stress"},{text:"Sensory / Head / Skin",next:"loc_sensory"},{text:"Metabolic / Energy / Temp",next:"loc_meta"},{text:"Deep Visceral / Flow",next:"en_block"}] },
            physical: { q: "Locating somatic source. Where is the pain centered?", options: [{text:"Spine / Back / Hips",next:"loc_spine"},{text:"Pelvis / Hips / Root",next:"loc_pelvis"},{text:"Limbs / Joints",next:"loc_limbs"}] },
            loc_spine: { q: "Specifying spinal vector...", options: [{text:"Bone / Structural Pain",result:"Tetrahedron"},{text:"Muscle Spasm / Tightness",result:"Cube"}] },
            loc_pelvis: { q: "Specifying pelvic/root vector...", options: [{text:"Internal / Rectal / Digestion",result:"Icosahedron"},{text:"Gluteal Muscle / Sciatica",result:"Cube"}] },
            loc_limbs: { q: "Specifying extremity vector...", options: [{text:"Joint / Arthritis Pain",result:"Tetrahedron"},{text:"Swelling / Fluid Retention",result:"Icosahedron"}] },
            loc_sensory: { q: "Is this a Surface or Cranial issue?", options: [{text:"Skin / Itching / Sensitivity",next:"iss_skin"},{text:"Head / Eyes / Sinus",next:"iss_head"}] },
            iss_skin: { q: "Characterize the sensation.", options: [{text:"Dry / Inflamed / Itchy",result:"Icosahedron"},{text:"Numbness / Tingling / Field",result:"Sphere"}] },
            iss_head: { q: "Characterize the pressure.", options: [{text:"Sinus / Ears / Air Pressure",result:"Octahedron"},{text:"Visual Strain / Light Sensitivity",result:"Dodecahedron"},{text:"Jaw / Nerve Tension",result:"Cube"}] },
            loc_meta: { q: "How is your energy regulation failing?", options: [{text:"Running Cold / Stalled / Slow",result:"Tetrahedron"},{text:"Overheating / Inflamed / Fast",result:"Icosahedron"},{text:"Adrenal Burnout / Fatigue",result:"Cube"}] },
            emo_stress: { q: "How does the stress manifest?", options: [{text:"Racing Mind / Panic",result:"Cube"},{text:"Grief / Heart Heaviness",result:"Torus"},{text:"Mental Fog / Scatter",result:"Octahedron"}] },
            en_block: { q: "Characterize the flow issue.", options: [{text:"Systemic Toxicity",result:"Dodecahedron"},{text:"EMF Sensitivity",result:"Sphere"},{text:"Lymphatic Backup",result:"Icosahedron"}] },
            path_optimize: { q: "What is your target outcome?", options: [{text:"Power & Willpower",result:"Tetrahedron"},{text:"Deep Grounding & Peace",result:"Cube"},{text:"Hyper-Focus & Clarity",result:"Octahedron"},{text:"Creativity & Flow",result:"Icosahedron"},{text:"Establish Acausal Clarity / Intentional Coherence",result:"Icosahedron_Intent"},{text:"Neuromuscular Discharge / Catharsis",result:"DISCHARGE_33"},{text:"Spiritual / DNA Evolution",result:"Dodecahedron"}] }
        };

        const protocolData = { 
            "Tetrahedron": {f:720,l:90,t:1440,d:"STRUCTURAL (24 MIN)", w:'sawtooth', v_vol: '75%', h_vol: '60%', msg:'Targeting dense tissue. Use a moderate-high volume to maximize vibration transfer to dense tissue (bones/muscle) via the chassis. Check that bass is audible but not distorted.'}, 
            "Octahedron": {f:1440,l:144,t:900,d:"MENTAL (15 MIN)", w:'sine', v_vol: '60%', h_vol: '40%', msg:'Targeting the Cranial/Air element. Use low-to-medium volume. High volume interferes with neural entrainment. Headphones require extra low volume to protect the eardrum from high frequencies.'}, 
            "DISCHARGE_33": {f:33,l:33,t:600,d:"DISCHARGE (10 MIN)", w:'sawtooth', v_vol: '85%', h_vol: '75%', msg:'CRITICAL: Gamma wave release (33Hz). Use HIGH VOLUME for maximum cathartic impact. Session duration is shorter due to high intensity.'},
            "Cube": {f:2160,l:270,t:1200,d:"GROUNDING (20 MIN)", w:'triangle', v_vol: '70%', h_vol: '50%', msg:'The Cube requires warm, stable pressure. Use medium volume (50-70%). The bass should be a warm, steady hum, NOT a loud thump.'}, 
            "Icosahedron": {f:360,l:45,t:1080,d:"FLUID (18 MIN)", w:'triangle', v_vol: '75%', h_vol: '55%', msg:'Targeting Vascular/Fluid systems. Use MODERATE-HIGH volume (55-75%) for smooth, rhythmic pulse transfer.'}, 
            "Icosahedron_Intent": {f:360,l:45,t:1200,d:"INTENTIONAL COHERENCE (20 MIN)", w:'triangle', v_vol: '60%', h_vol: '40%', msg:'Targeting Mental Clarity. Use LOW-MEDIUM volume (40-60%). The focus is internal alignment, not physical force.'}, 
            "Dodecahedron": {f:432,l:108,t:1980,d:"CELLULAR (33 MIN)", w:'sawtooth', v_vol: '75%', h_vol: '60%', msg:'Targeting DNA/Aetheric Field. Use MODERATE-HIGH volume (60-75%) for deep, harmonically rich penetration.'}, 
            "Torus": {f:194.18,l:55,t:1320,d:"HEART (22 MIN)", w:'triangle', v_vol: '70%', h_vol: '50%', msg:'Targeting Cardia-Rhythm. Use MEDIUM volume (50-70%) for gentle, consistent input to allow natural synchronization.'}, 
            "Sphere": {f:7.83,l:7.83,t:2700,d:"FIELD (45 MIN)", w:'sine', v_vol: '65%', h_vol: '30%', msg:'Targeting EMF/Boundary. Use LOW volume (30-65%). The objective is a subtle, pervasive anchor tone.'} 
        };

        function handleDoctorTap() {
            tapCounter++;
            if (tapCounter === 5) {
                toggleArchitectMode();
                tapCounter = 0;
            }
            // Reset counter after a pause to prevent accidental activation
            setTimeout(() => { tapCounter = 0; }, 1000);
        }

        function toggleArchitectMode() {
            const consoleDiv = document.getElementById('architect-console');
            if (consoleDiv.style.display === 'flex') {
                consoleDiv.style.display = 'none';
            } else {
                consoleDiv.style.display = 'flex';
            }
        }

        function initChat() {
            const win = document.getElementById('chat-window'); win.innerHTML = "";
            setTimeout(() => loadAIQuestion('start'), 500);
        }
        function addAIMessage(text) {
            const win = document.getElementById('chat-window'); const row = document.createElement('div'); row.className = 'msg-row';
            const bubble = document.createElement('div'); bubble.className = 'msg-ai-bubble'; bubble.innerText = text;
            row.appendChild(bubble); win.appendChild(row); win.scrollTop = win.scrollHeight;
        }
        function addUserMessage(text) {
            const win = document.getElementById('chat-window'); const row = document.createElement('div'); row.className = 'msg-row';
            const bubble = document.createElement('div'); bubble.className = 'msg-user-bubble'; bubble.innerText = text;
            row.appendChild(bubble); win.appendChild(row); win.scrollTop = win.scrollHeight;
        }
        function loadAIQuestion(key) {
            const node = diagnosticTree[key]; addAIMessage(node.q);
            setTimeout(() => {
                const win = document.getElementById('chat-window'); const cDiv = document.createElement('div'); cDiv.className = 'choice-container';
                node.options.forEach(opt => {
                    const btn = document.createElement('button'); btn.className = 'choice-btn'; 
                    btn.innerHTML = `<span>${opt.text}</span><span>âžœ</span>`;
                    btn.onclick = () => {
                        cDiv.remove(); addUserMessage(opt.text);
                        setTimeout(() => { if(opt.next) loadAIQuestion(opt.next); else showAIResult(opt.result); }, 600);
                    }; cDiv.appendChild(btn);
                }); win.appendChild(cDiv); win.scrollTop = win.scrollHeight;
            }, 1000);
        }
        function showAIResult(result) {
            const p = protocolData[result]; pendingDiagnosis = result;
            addAIMessage(`Assessment Complete. ${p.d}`);
            setTimeout(() => {
                const win = document.getElementById('chat-window'); const card = document.createElement('div'); card.className = 'prescription-card';
                card.innerHTML = `<div class="rx-header">AUTO-DOSE</div><div class="rx-title">${result.toUpperCase().replace('_INTENT','').replace('_EXPLODE','').replace('DISCHARGE_33', 'GAMMA DISCHARGE')}</div><div class="rx-time">${p.d}</div><button class="apply-btn" onclick="applyDiagnosis()">BEGIN TREATMENT</button><button style="background:none; border:none; color:#666; margin-top:10px; cursor:pointer; font-size:11px;" onclick="initChat()">RESET</button>`;
                win.appendChild(card); win.scrollTop = win.scrollHeight;
            }, 800);
        }
        function applyDiagnosis() {
            if(!pendingDiagnosis) return;
            showTab('controls', document.getElementById('nav-ctrl'));
            showPreSessionModal(pendingDiagnosis);
        }

        // --- PRE-SESSION MODAL ---
        function showPreSessionModal(name) {
            pendingDiagnosis = name;

            const p = protocolData[name];
            const isHeadset = systemMode === 'headset';
            const targetVolume = isHeadset ? p.h_vol : p.v_vol;
            
            const modeText = isHeadset ? `HEADSET MODE: Binaural Entrainment is active.` : `VEHICLE MODE: Chassis Vibration is active.`;
            const volumeInstruction = `Set device volume to **${targetVolume}** for optimal clinical amplitude.`;

            document.getElementById('modal-title').innerText = `PROTOCOL: ${name.toUpperCase().replace('_INTENT', '').replace('_EXPLODE', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE')}`;
            document.getElementById('modal-instruct-text').innerHTML = `
                <div style="font-weight: bold; color: #fff;">${modeText} | RX TIME: ${p.d}</div>
                <div class="modal-warn" style="margin-top: 10px;">${volumeInstruction}</div>
                <div style="margin-top: 10px; color: #ffd700;">Clinical Focus: ${p.msg}</div>
            `;
            document.getElementById('modal-instruct-text').innerHTML += `
                <div class="volume-visual">${}</div>
            `;
            document.getElementById('pre-session-modal').style.display = 'flex';
        }

        function startTreatmentNow() {
            document.getElementById('pre-session-modal').style.display = 'none';
            if (pendingDiagnosis) {
                playFreq(pendingDiagnosis);
                pendingDiagnosis = null;
            } else if (lastGeo) {
                playFreq(lastGeo); 
            }
        }


        // --- CORE AUDIO & TIMER ---
        function selectLaunchMode(m) { systemMode=m; document.getElementById('active-mode-name').innerText=m.toUpperCase(); initAudio(); showTab('diagnostic', document.getElementById('nav-diag')); }
        function toggleMode() { let nm=(systemMode==='vehicle')?'headset':'vehicle'; if(confirm(`Switching to ${nm.toUpperCase()}. Confirm?`)){stopAll(false); systemMode=nm; document.getElementById('active-mode-name').innerText=nm.toUpperCase();} }
        function showTab(id, btn) { document.querySelectorAll('.tab-panel').forEach(e=>e.classList.remove('visible')); document.getElementById(id).classList.add('visible'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); if(id==='diagnostic' && document.getElementById('chat-window').innerHTML==="") initChat(); if(id==='data') loadData(); }
        
        let filterNode = null;
        function initAudio() { 
            if (!audioCtx){
                const AC=window.AudioContext||window.webkitAudioContext; audioCtx=new AC(); 
                masterGain=audioCtx.createGain(); 
                
                filterNode = audioCtx.createBiquadFilter();
                filterNode.type = 'lowpass';
                filterNode.frequency.setValueAtTime(1200, audioCtx.currentTime); 
                
                filterNode.connect(masterGain);
                masterGain.connect(audioCtx.destination);
            } else if(audioCtx.state==='suspended') audioCtx.resume(); 
        }
        
        function playFreq(name) {
            initAudio(); stopAll(false);
            const p = protocolData[name];
            sessionStart=Date.now(); startBPM=currentBPM; currentGeo=name; currentHigh=p.f; currentLow=p.l;
            lastGeo=name; isPlaying=true; remainingSeconds = p.t;

            document.querySelectorAll('.med-btn').forEach(b=>b.classList.remove('active-protocol'));
            document.getElementById('btn-'+name.replace('_Intent', '').replace('_Explode', '').replace('DISCHARGE_33', 'Tetrahedron')).classList.add('active-protocol');
            
            updateStatus("TREATING","#00e5ff",name,p.f,p.l); 
            
            // Determine Gains (Automated Volume)
            const MIND_GAIN = 0.15;
            let highGain = (name === 'DISCHARGE_33') ? 0.4 : MIND_GAIN; 
            let lowGain = (systemMode === 'vehicle') ? 0.8 : 0.4;
            let waveType = p.w;

            const now = audioCtx.currentTime;
            const globalVoiceGain = audioCtx.createGain();
            globalVoiceGain.connect(filterNode);
            
            if (systemMode === 'vehicle') {
                // VEHICLE MODE (Physical)
                oscHigh=audioCtx.createOscillator(); oscHigh.type=waveType; oscHigh.frequency.value=p.f; let g1=audioCtx.createGain(); g1.gain.value=highGain; oscHigh.connect(g1); g1.connect(globalVoiceGain); oscHigh.start();
                oscLow=audioCtx.createOscillator(); oscLow.type=waveType; oscLow.frequency.value=p.l; let g2=audioCtx.createGain(); g2.gain.value=lowGain; oscLow.connect(g2); g2.connect(masterGain); oscLow.start();
                if(p.f>60){oscBin=audioCtx.createOscillator(); oscBin.type='sine'; oscBin.frequency.value=p.f+7.83; let g3=audioCtx.createGain(); g3.gain.value=0.05; oscBin.connect(g3); g3.connect(globalVoiceGain); oscBin.start();}
            } else {
                // HEADSET MODE (Binaural)
                let pL=audioCtx.createStereoPanner(); pL.pan.value=-1; pL.connect(globalVoiceGain); let pR=audioCtx.createStereoPanner(); pR.pan.value=1; pR.connect(globalVoiceGain); let pC=audioCtx.createStereoPanner(); pC.pan.value=0; pC.connect(globalVoiceGain);
                
                oscHigh=audioCtx.createOscillator(); oscHigh.type=waveType; oscHigh.frequency.value=p.f; let g1=audioCtx.createGain(); g1.gain.value=highGain; oscHigh.connect(g1); g1.connect(pL); oscHigh.start();
                oscBin=audioCtx.createOscillator(); oscBin.type=waveType; oscBin.frequency.value=p.f+7.83; let g3=audioCtx.createGain(); g3.gain.value=highGain; oscBin.connect(g3); g3.connect(pR); oscBin.start();
                oscLow=audioCtx.createOscillator(); oscLow.type='sine'; oscLow.frequency.value=p.l; let g2=audioCtx.createGain(); g2.gain.value=lowGain; oscLow.connect(g2); g2.connect(pC); oscLow.start();
            }

            // ENVELOPE: Apply fast attack for Explosive Mode
            if (name === 'DISCHARGE_33') {
                globalVoiceGain.gain.setValueAtTime(0.0001, now);
                globalVoiceGain.gain.exponentialRampToValueAtTime(1.0, now + 0.05); // Fast snap
            } else {
                globalVoiceGain.gain.setValueAtTime(1.0, now); // Standard immediate volume
            }

            // Start Timer
            startTimer();
        }

        function startTimer() {
            if(doseTimer) clearInterval(doseTimer);
            updateGlobalBtn(); 
            doseTimer = setInterval(() => {
                remainingSeconds--;
                if(remainingSeconds <= 0) {
                    stopAll(true);
                    alert("CLINICAL DOSAGE COMPLETE.");
                } else {
                    updateGlobalBtn();
                }
            }, 1000);
        }

        function stopAll(save) {
            if(doseTimer) clearInterval(doseTimer); doseTimer = null;
            if(oscHigh){try{oscHigh.stop();}catch(e){} oscHigh=null;} if(oscLow){try{oscLow.stop();}catch(e){} oscLow=null;} if(oscBin){try{oscBin.stop();}catch(e){} oscBin=null;}
            document.querySelectorAll('.med-btn').forEach(b=>b.classList.remove('active-protocol'));
            updateStatus("STANDBY","#fff","--",0,0); isPlaying=false; updateGlobalBtn();
            if(save && currentGeo && sessionStart>0) {
                const dur=Math.round((Date.now()-sessionStart)/1000);
                let drop = (startBPM>0 && currentBPM>0) ? (startBPM-currentBPM) : 0;
                saveSession(currentGeo, currentHigh, currentLow, dur, systemMode, drop);
                currentGeo=""; sessionStart=0;
            }
        }

        function updateStatus(s,c,n,h,l) { 
            let display_name = n.replace('_Intent', '').replace('_Explode', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE');
            document.getElementById('geo-text').innerText=display_name; document.getElementById('geo-text').style.color=c; 
            document.getElementById('freq-text').innerText=h+" Hz"; document.getElementById('vib-text').innerText=l+" Hz"; 
        }
        
        function handleGlobalClick() { 
            if(isPlaying){stopAll(true);}
            else if(lastGeo){showPreSessionModal(lastGeo);}
            else{showTab('controls',document.getElementById('nav-ctrl'));} 
        }
        
        function updateGlobalBtn() { 
            const b=document.getElementById('global-btn'); b.className='global-btn'; 
            if(isPlaying){
                let m = Math.floor(remainingSeconds / 60);
                let s = remainingSeconds % 60;
                let txt = (s < 10) ? "0"+s : s;
                b.classList.add('btn-active');
                b.innerText = `TREATING: ${m}:${txt} (TAP TO STOP)`;
            } else if(lastGeo){
                b.classList.add('btn-resume');
                b.innerText = "RESUME: "+lastGeo.replace('_Intent', '').replace('_Explode', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE');
            } else {
                b.classList.add('btn-idle');
                b.innerText = "SELECT PROTOCOL";
            } 
        }

        // --- BIO & ARCHIVE ---
        async function connectBluetooth() { try{const d=await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']}]}); const s=await d.gatt.connect(); const v=await s.getPrimaryService('heart_rate'); const c=await v.getCharacteristic('heart_rate_measurement'); c.startNotifications(); c.addEventListener('characteristicvaluechanged',e=>updateBio(e.target.value.getUint8(1))); document.getElementById('bio-panel').style.borderColor="#00e5ff";}catch(e){alert("BLE Failed.");} }
        function tapTempo() { const n=Date.now(); tapTimes.push(n); if(tapTimes.length>4)tapTimes.shift(); if(tapTimes.length>=2){let i=[]; for(let x=1;x<tapTimes.length;x++)i.push(tapTimes[x]-tapTimes[x-1]); updateBio(Math.round(60000/(i.reduce((a,b)=>a+b)/i.length)));} }
        function updateBio(b) { currentBPM=b; if(startBPM===0)startBPM=b; document.getElementById('bpm-display').innerText=b; document.getElementById('bio-panel').style.borderColor=(b>90)?"#ff5252":"#00e5ff"; }
        function saveSession(t, h, l, d, m, drop) {
            const logs = JSON.parse(localStorage.getItem('cryo_logs_v20') || "[]");
            const dateStr = new Date().toISOString().substring(0,16).replace('T',' ');
            let modeTag = (m === 'vehicle') ? "[PHYS]" : "[NEURO]";
            let eff = (drop > 0) ? `EFF:+${drop}` : (drop < 0) ? `EFF:${drop}` : `EFF:--`;
            const entry = `${dateStr} | ${modeTag} | ${t.padEnd(12)} | ${d}s | ${eff}`;
            logs.unshift(entry); if(logs.length>200)logs.pop();
            localStorage.setItem('cryo_logs_v20', JSON.stringify(logs));
        }
        function loadData() {
            const logs = JSON.parse(localStorage.getItem('cryo_logs_v20') || "[]");
            const tm = document.getElementById('log-terminal');
            if (logs.length === 0) { tm.value = "NO RECORDS."; return; }
            let out = "DATE             | ENV    | PROTOCOL     | DUR   | RESULT\n-----------------------------------------------------------\n";
            logs.forEach(l => out += l + "\n"); tm.value = out;
        }
        function selectAllData() { const t=document.getElementById('log-terminal'); t.select(); t.setSelectionRange(0,99999); }
        function clearData() { if(confirm("DELETE ALL RECORDS?")) { localStorage.removeItem('cryo_logs_v20'); loadData(); } }
        function toggleBreath() { const c=document.getElementById('breath-circle'); const l=document.getElementById('breath-text'); if(isBreathing){isBreathing=false; clearTimeout(breathTimer); c.className="circle"; l.innerText="READY"; l.style.color="#fff";} else{isBreathing=true; loopBreath(c,l,'in');} }
        function loopBreath(c,l,p) { if(!isBreathing)return; if(p==='in'){c.className="circle inhale"; l.innerText="INHALE"; l.style.color="#00e5ff"; breathTimer=setTimeout(()=>loopBreath(c,l,'out'),5500);} else{c.className="circle exhale"; l.innerText="EXHALE"; l.style.color="#555"; breathTimer=setTimeout(()=>loopBreath(c,l,'in'),5500);} }
    </script>
</body>
</html>
